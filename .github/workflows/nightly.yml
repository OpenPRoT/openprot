# Licensed under the Apache-2.0 license

name: Nightly

on:
  schedule:
    - cron: '0 2 * * *'  # Run every day at 2 AM UTC
  workflow_dispatch:     # Allow manual triggering

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  nightly-build:
    name: Nightly Build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v5

    - name: Setup Bazel
      uses: bazel-contrib/setup-bazel@0.18.0
      with:
        bazelisk-cache: true
        disk-cache: true
        repository-cache: true

    - name: Build
      run: |
        bazel build \
            --keep_going \
            --build_tag_filters=-hardware,-disabled \
            //...

  nightly-test:
    name: Nightly Test
    needs: nightly-build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5

    - name: Setup Bazel
      uses: bazel-contrib/setup-bazel@0.18.0
      with:
        bazelisk-cache: true
        disk-cache: true
        repository-cache: true

    - name: Run tests
      run: |
        bazel test \
            --keep_going \
            --test_output=streamed \
            --build_tag_filters=-hardware,-disabled \
            --test_tag_filters=-hardware,-disabled \
            //...
